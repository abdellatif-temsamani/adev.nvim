local config_merge = require "adev.onboarding.config-merge"
local defaults = require "adev.defaults"
local utils = require "adev-common.utils"

local OnBoarding = {
    init = utils.files:get_config_file "/init.lua",
    init_opts = utils.files:get_config_file "/lua/adev/init-opts.lua",
}

--- get user current config in `init-opts`
---@return SetupOpts currents
local function get_user_config()
    local status, current = pcall(require, "adev.init-opts")
    if not status then
        current = defaults
    end
    return current
end

--- checks if current config has differences than the default config
---@return boolean
function OnBoarding.config_changed()
    local current = get_user_config()
    return not utils.compare_keys(defaults, current)
end

--- checks if the user is new and haven't generated config yet
---@return boolean - if `true` then user is new
function OnBoarding:first_time()
    local config_exists = not (
        utils.files.file_exists(self.init) and utils.files.file_exists(self.init_opts)
    )
    return config_exists
end

--- onboarding a new user by generating a new config
--- init.lua and init-opts.lua
function OnBoarding:onboarding()
    local config = defaults
    if not self:first_time() then
        if self.config_changed() then
            --- we need to merge the two configs then
            local current = get_user_config()
            ---@type SetupOpts
            config = config_merge.merge_configs(defaults, current)
        else
            return
        end
    end

    local opts_lines = {
        "-- NOTE: all config will be preserved\n",
        "-- Auto-generated by adev configuration\n",
        "-- Configuration options for adev.nvim\n",
        "-- NOTE: this file ignored by git\n",
        "---@type SetupOpts\n",
        "return ",
        vim.inspect(config),
        "\n",
    }

    local init_lines = {
        "-- NOTE: DO NOT MODIFY THIS FILE\n",
        "-- Auto-generated by adev configuration\n",
        "-- Main setup file for adev.nvim\n",
        "local status, opts = pcall(require, 'adev.init-opts')\n",
        "if status then \n",
        '\trequire("adev").setup(opts)\n',
        "else\n",
        '\tvim.notify("Failed to load adev config: " .. tostring(opts), vim.log.levels.ERROR)\n',
        "end\n",
        "\n",
    }

    local success, err = pcall(function()
        utils.files.write_file(self.init_opts, opts_lines)
        utils.files.write_file(self.init, init_lines)
    end)

    assert(success, "Save failed: " .. tostring(err))

    utils.notify "adev.nvim configuration created"
    utils.restart_neovim(2000)
end

-- TODO: overhaul to custom UI
function OnBoarding.edit_config()
    utils.files.open_file(OnBoarding.init_opts)
end

return OnBoarding
